---
layout: article
title: 区块链：比特币交易
date: 2021-02-17 00:11:00 +0800
tags: [Blockchain]
categories: blog
pageview: true
key: knowledge-of-blockchain-BTC
---

> 参考文献：
>
> - [http://c.biancheng.net/blockchain/](http://c.biancheng.net/blockchain/)
>- [比特币私钥、公钥、钱包地址之间的关系](https://www.sohu.com/a/344730721_100217347)
> - [比特币交易中的签名与验证](https://blog.csdn.net/AAA123524457/article/details/107693278)
>- [区块链底层技术详解](https://zhuanlan.zhihu.com/p/121039362)

### 1.比特币交易流程———如何转账

![image-20210217152547381](https://raw.githubusercontent.com/jjzhou012/image/master/blogImg20210217152547.png)



### 2.比特币私钥、公钥、钱包地址之间的关系

<img src="https://raw.githubusercontent.com/jjzhou012/image/master/blogImg20210217155309.png" alt="image-20210217155308961" style="zoom: 80%;" />

- **私钥**：控制着比特币账户的所有权，拥有了这串数字就可以对相应“钱包地址”中的比特币进行操作。
- **公钥**：私钥经过一种（椭圆曲线算法），可以算得公钥；公钥无法反向计算出私钥（非对称加密）。
- **公钥哈希**：『公钥』可以经过哈希算法计算得到『公钥哈希』，而反过来是行不通的。
- **钱包地址**：公钥哈希经过计算编码得到钱包地址，『公钥哈希』和『钱包地址』可以通过互逆运算进行转换，所以它们是等价的。



<img src="https://raw.githubusercontent.com/jjzhou012/image/master/blogImg20210217155339.png" alt="image-20210217155339203" style="zoom:80%;" />

**使用『私钥』对交易进行签名**，比特币钱包间的转账是通过“交易”实现的，交易数据是由“转出钱包私钥”的所有者生成的，也就是说有了『私钥』就可以花费该钱包的比特币余额。

- 交易的原始数据包括“转账数额”和“转入钱包地址”，但是仅有这些是不够的，因为无法证明交易的生成者对“转出钱包地址”余额有动用的权利。所以需要用『私钥』对原始数据进行**签名**。

- 将“转出签名”和“转出公钥”添加到原始交易数据中，生成了正式的交易数据，这样它就可以被广播到比特币网络进行转账了。



**使用『公钥』对签名进行验证**

<img src="https://raw.githubusercontent.com/jjzhou012/image/master/blogImg20210217163838.png" alt="image-20210217163838779" style="zoom:80%;" />

交易数据被广播到比特币网络后，节点会对这个交易数据进行检验，其中就包括对签名的校验。如果校验正确，那么这笔余额就成功地从“转出钱包”转移到“转入钱包”了。

签名验证的目的有两个：

1. 证明交易所引用的UTXO的确属于付款人。
2. 证明交易的所有数据的确是付款人提供的，且未被修改过。



### 3.UTXO: unspent transaction outputs (未使用的交易输出)

在比特币系统上其实并不存在“账户”，而只有“地址”。只要你愿意，你就可以在比特币区块链上开设无限多个钱包地址，你拥有的比特币数量是你所有的钱包地址中比特币的总和。比特币系统并不会帮你把这些地址汇总起来形成你的账户。

我们来看一个两个人进行转账交易的过程，以深入理解UTXO：

> 假设我有 8 个比特币，这其实意味着，之前有一个交易把这些比特币转入我的地址，这个交易的输出（即 8 个比特币）未被使用，我拥有了这 8 个比特币。
>
> 现在，我要发起一个转账交易，这个交易中的输入是让我拥有这些比特币的上一个交易。
>
> 我要转账给你，我做的是，对让我拥有这些 8 个比特币的上一个交易进行签名，把这一新转账交易的输出地址设为你的钱包地址。
>
> 这样，我就发起了一个转账支付交易。等矿工将这一交易打包进新的区块，转账交易完成，这 8 个比特币就属于你了。你拥有的是你我这个交易的未使用的交易输出。

以上两个人的转账交易过程是：我用私钥（从一个输出是我的地址的交易中）取出比特币，并用私钥对从我的地址转到你的地址的新交易进行签名。一旦交易完成，这些比特币就转到你的钱包地址中去。你的钱包中新交易的未使用交易输出，只有你的私钥才可以打开。

从以上讨论中我们可以看到，的确不存在比特币，只有未使用的交易输出（UTXO）。每一笔比特币都源自上一个交易，可以一直向上追溯上去。而一直向上追溯，在每一笔比特币的源头，都有一种特殊的交易，即比特币矿工因[挖矿](http://c.biancheng.net/view/1898.html)获得奖励的**创币交易**，每一个比特币都是通过挖矿被创造出来的。假设我作为比特币矿工挖矿成功赢得了 25 个比特币，那么这个特殊交易是，它的输入是 0，而输出是 25 个比特币进到矿工的钱包地址中。

**创币交易是一个特殊的交易，它没有输入（或者说输入为0），只有输出。**

我们知道每个交易都有输入部分和输出部分，而输入部分的BTC会略微大于输出部分的BTC，主要是产生了交易费。

输出（output）部分都会保存在UTXO集合中，只要输出部分的这个比特币没有花费掉，就一直会保存在UTXO中，所以UTXO的集合是不断变大的，可能有些人始终不花或忘记（丢失）了自己的私钥，想花也花不了。

其实输入部分也是来自于UTXO，这个交易的输入部分也就是上个交易的输出部分。

<img src="https://raw.githubusercontent.com/jjzhou012/image/master/blogImg20210217225017.png" alt="image-20210217225017230" style="zoom:80%;" />

此外，**每个交易可以有多个输入和多个输出，因为每个输出到UTXO的BTC只能作为整体来使用。**这就好比现实生活中的找零钱，所以通常每一笔交易都会有一个找零钱的地址，这样就形成了多个输出。或者需要支付一个比较大的BTC给对方，这时可能会有多个输入来凑够。

> **按照比特币系统的设计，比特币交易还要遵循一个原则：每一次交易的输入值都必须全部花掉，不能只花掉部分**。比如，我要转出比特币给你的钱包地址中只有 8 个比特币，那么很简单，我发起一个交易，把这 8 个比特币转到你的钱包地址中，我签名确认这个交易。但假如我的钱包地址中有 25 个比特币，那我发起的交易就不是转给你 8 个比特币，然后自己的钱包地址中还剩下 17 个比特币。这时，我发起的交易是：从我的钱包地址中转 8 个比特币给你，同时转 17 个比特币给我的同一地址。

可以这样理解，UTXO相当于承担中间人的作用，对于一笔交易而言，输入部分就是花费UTXO中上个交易的输出部分，会产生新的输出部分存在UTXO中，然后下个交易的输入部分又会花费掉刚存在UTXO的输出，这样依次类推，就形成了一个完整的交易链且不断的链下去。这就是为什么说比特币是基于交易的账本模式。

UTXO可以很好的解决双花（double spending）问题，每笔交易的输入部分要知道比特币的来源，如果已经花过一次了，如果再花一次，在UTXO中就找不到比特币的来源，就是不合法的，当然交易也就不会成立。